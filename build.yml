name: neon
default: [clean, test, integ, bin]
doc: "Build file to build neon"

properties:
  NAME:         "neon"
  VERSION:      "0.1.0"
  BUILD_DIR:    "build"
  ARC_DIR:      "#{BUILD_DIR}/#{NAME}-#{VERSION}"
  DEPENDENCIES:
  - "gopkg.in/yaml.v2"
  - "github.com/fatih/color"
  - "github.com/mitchellh/gox"
  - "github.com/mattn/anko"
  - "github.com/mattn/go-zglob"

environment:
  GOPATH: "${BASE}"
  PATH:   "${BASE}/bin:${PATH}"

targets:

  deps:
    doc: "Install libraries"
    steps:
    - for: dependency
      in:  DEPENDENCIES
      do:
      - "go get #{dependency}"

  test:
    doc: "Run unit tests"
    steps:
    - "go test #{NAME}/..."

  integ:
    doc: "Run an integration test on a build file"
    steps:
    - "neon -file src/neon/test.yml"

  bin:
    doc: "Build neon binary"
    steps:
    - "go install #{NAME}"

  archive:
    depends: clean
    doc: "Generate distribution archive"
    steps:
    - mkdir: "#{ARC_DIR}/bin/"
    - "gox -output=#{ARC_DIR}/bin/{{.Dir}}_{{.OS}}_{{.Arch}} #{NAME}"
    - "cp LICENSE.txt #{ARC_DIR}/"
    - "md2pdf -o #{ARC_DIR}/README.pdf README.md"
    - "changelog to markdown > #{BUILD_DIR}/CHANGELOG.md"
    - "md2pdf -o #{ARC_DIR}/CHANGELOG.pdf #{BUILD_DIR}/CHANGELOG.md"
    - remove: "#{BUILD_DIR}/CHANGELOG.md"
    - chdir: "#{BUILD_DIR}"
    - "tar cvzf #{NAME}-#{VERSION}.tar.gz #{NAME}-#{VERSION}"

  release:
    depends: [clean, test, archive]
    doc: "Perform a release"
    steps:
    - "release"

  clean:
    doc: "Clean generated files"
    steps:
    - delete: "#{BUILD_DIR}"
